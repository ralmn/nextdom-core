#!/bin/bash

set -e

set_root() {
  local this=$(readlink -n -f $1)
  local bin=$(dirname $this)
  root=$(dirname $(dirname $bin))
}

set_root $0
cd ${root}

args=""
case $1 in
  "dev")
    args="-f ${root}/docker/build/dev/docker-compose.yml"
    ;;
  "test")
    args="-f ${root}/docker/build/test/docker-compose.yml"
    ;;
  "prod")
    args="-f ${root}/docker/build/prod/docker-compose.yml"
    ;;
  *)
    echo "usage: compose { dev | test | prod } [ docker-compose-options ]"
    exit 1
esac
shift

BUILD_VERSION=$(git describe --exact-match --tags $(git log -n1 --pretty='%h') 2>/dev/null || echo local)
BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
VCS_REF=$(git rev-parse HEAD)
[[ -n $(git status -s) ]] && {
  VCS_REF="${VCS_REF}-dirty"
}

export BUILD_VERSION
export BUILD_DATE
export VCS_REF

docker-compose ${args} $@
